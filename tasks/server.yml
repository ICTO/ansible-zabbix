---
# Prepare database setup
- include: tasks/db.yml
  when_boolean: ${with_zabbix_server}

# Install Zabbix server dependencies
- name: "Install Zabbix server dependencies"
  action: ${ansible_pkg_mgr} pkg=${item} state=installed update-cache=yes
  when_boolean: ${with_zabbix_server}
  with_items: ${zabbix_server.dependencies}
  tags:
    - zabbix_server

# Fetch .deb file from repository
- name: "Fetch Debian package: ${zabbix_server.debian_package}"
  action: get_url url=${zabbix.debian_repo}/${zabbix_server.debian_package} dest=${zabbix.tmp_dir} mode=0440 owner=root group=root
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Install Zabbix server deb file
- name: "Install Zabbix server: ${zabbix_server.debian_package}"
  action: shell dpkg -i -E ${zabbix.tmp_dir}/${zabbix_server.debian_package} 2>&1 | grep skipping | wc -l
  register: server_installed
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Execute db installation scripts
- name: "Execute Zabbix SQL files"
  action: shell zcat /usr/share/zabbix-server-mysql/${item}.sql.gz | mysql -u${zabbix_server.db.user} -p${zabbix_server.db.pass} ${zabbix_server.db.name}
  when_boolean: "${with_zabbix_server} and ${create_db.changed}"
  with_items: ${zabbix_server.db.sql_files}
  tags:
    - zabbix_server

# Create Zabbix server include directory
- name: "Create Zabbix server include directory"
  action: file path=/etc/zabbix/zabbix_server.conf.d group=root owner=root mode=0750 state=directory
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Enable Zabbix server include directory
- name: "Enable Zabbix server include directory"
  action: lineinfile dest=/etc/zabbix/zabbix_server.conf regexp="^.*Include=/etc/zabbix/zabbix_server.conf.d/" line="Include=/etc/zabbix/zabbix_server.conf.d/"
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Enable Zabbix server in /etc/default/zabbix-server
- name: "Enable Zabbix server in /etc/default/zabbix-server"
  action: lineinfile dest=/etc/default/zabbix-server regexp="^START=" line="START=yes"
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Override defaults from Zabbix server config file
- name: "Put custom Zabbix server settings in include dir"
  action: template src=templates/zabbix_server.conf.j2 dest=/etc/zabbix/zabbix_server.conf.d/custom.conf owner=root group=root mode=0640
  notify:
    - "Restart Zabbix server"
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server

# Ensure Zabbix server is running
- name: "Ensure Zabbix server is running"
  action: service name=${zabbix_server.name} state=started
  when_boolean: ${with_zabbix_server}
  tags:
    - zabbix_server